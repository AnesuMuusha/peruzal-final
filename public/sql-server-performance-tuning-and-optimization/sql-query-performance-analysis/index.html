<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>SQL Query Performance Analysis - SQL Server Performance and Tuning</title>
    <meta name="generator" content="Hugo 0.18.1" />

    
    <meta name="description" content="SQL Server Performance and Tuning">
    
    <link rel="canonical" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/sql-query-performance-analysis/">
    
    <meta name="author" content="Peruzal">
    

    <meta property="og:url" content="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/sql-query-performance-analysis/">
    <meta property="og:title" content="SQL Server Performance and Tuning">
    <meta property="og:image" content="http://guides.peruzal.com/images/logo.png">
    <meta name="apple-mobile-web-app-title" content="SQL Server Performance and Tuning">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/fonts/icon.eot');
        src: url('http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/fonts/icon.eot')
               format('embedded-opentype'),
             url('http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/fonts/icon.woff')
               format('woff'),
             url('http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/fonts/icon.ttf')
               format('truetype'),
             url('http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/stylesheets/application.css">
    <link rel="stylesheet" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/stylesheets/temporary.css">
    <link rel="stylesheet" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/stylesheets/palettes.css">
    <link rel="stylesheet" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/stylesheets/highlight/highlight.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/styles/github-gist.min.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu&#43;Mono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-deep-orange palette-accent-light-blue">




<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        SQL Query Performance Analysis
      </div>
    </div>

    
    <div class="button button-twitter" role="button" aria-label="Twitter">
       <a href="https://twitter.com/peruzal" title="@peruzal on Twitter" target="_blank" class="toggle-button icon icon-twitter"></a>
    </div>
    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/peruzal" title="@peruzal on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/images/logo.png">
        </div>
      
      <div class="name">
        <strong>SQL Server Performance and Tuning <span class="version">1.0.0</span></strong>
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Introduction" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/">
	
	Introduction
</a>



  
</li>



<li>
  
    



<a  title="Performance Tuning Overview" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/performance-tuning-overview/">
	
	Performance Tuning Overview
</a>



  
</li>



<li>
  
    



<a  title="SQL Performance Analysis" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/sql-performance-analysis/">
	
	SQL Performance Analysis
</a>



  
</li>



<li>
  
    



<a class="current" title="SQL Query Performance Analysis" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/sql-query-performance-analysis/">
	
	SQL Query Performance Analysis
</a>


<ul id="scrollspy">
</ul>


  
</li>



<li>
  
    



<a  title="Index Analysis" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/index-analysis/">
	
	Index Analysis
</a>



  
</li>



<li>
  
    



<a  title="Database Tuning Advisor" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/database-tuning-advisor/">
	
	Database Tuning Advisor
</a>



  
</li>



<li>
  
    



<a  title="Boomark Lookup Analysis" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/bookmark-lookup-analysis/">
	
	Boomark Lookup Analysis
</a>



  
</li>



<li>
  
    



<a  title="Statistics Analysis" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/statistics-analysis/">
	
	Statistics Analysis
</a>



  
</li>



<li>
  
    



<a  title="Index Fragmentation Analysis" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/index-fragmentation-analysis/">
	
	Index Fragmentation Analysis
</a>



  
</li>



<li>
  
    



<a  title="Execution Plan Cache Analysis" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/execution-plan-cache-analysis/">
	
	Execution Plan Cache Analysis
</a>



  
</li>



<li>
  
    



<a  title="Query Recompilation" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/query-recompilation/">
	
	Query Recompilation
</a>



  
</li>



<li>
  
    



<a  title="Query Design Analysis" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/query-design-analysis/">
	
	Query Design Analysis
</a>



  
</li>



<li>
  
    



<a  title="Blocking Analysis" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/blocking-analysis/">
	
	Blocking Analysis
</a>



  
</li>



<li>
  
    



<a  title="Deadlock Analysis" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/deadlock-analysis/">
	
	Deadlock Analysis
</a>



  
</li>



<li>
  
    



<a  title="Cursor Cost Analysis" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/cursor-cost-analysis/">
	
	Cursor Cost Analysis
</a>



  
</li>



<li>
  
    



<a  title="Database Performance Stress Testing" href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/database-performance-stress-testing/">
	
	Database Performance Stress Testing
</a>



  
</li>


        </ul>
        

        
        <hr>
        <span class="section">The author</span>
        
        <ul>
          
          <li>
            <a href="https://twitter.com/peruzal" target="_blank" title="@peruzal on Twitter">
              @peruzal on Twitter
            </a>
          </li>
          

          
          <li>
            <a href="https://github.com/peruzal" target="_blank" title="@peruzal on GitHub">
              @peruzal on GitHub
            </a>
          </li>
          

          
          <li>
            <a href="mailto:hello@peruzal.com" title="Email of hello@peruzal.com">
              Contact via email
            </a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>SQL Query Performance Analysis </h1>

			

<ul>
<li><a href="#extended-events">Extended Events</a></li>
<li><a href="#benefits-of-sql-server-extended-events">Benefits of SQL Server Extended Events</a>

<ul>
<li><a href="#sql-server-management-studio-extended-events-integration">SQL Server Management Studio Extended Events Integration</a></li>
</ul></li>
<li><a href="#extended-events-concepts">Extended Events Concepts</a>

<ul>
<li><a href="#package">Package</a></li>
<li><a href="#package-contents">Package Contents</a></li>
<li><a href="#events">Events</a></li>
<li><a href="#event-categorization">Event Categorization</a></li>
<li><a href="#channel">Channel</a></li>
<li><a href="#keyword">Keyword</a></li>
<li><a href="#targets">Targets</a></li>
<li><a href="#actions">Actions</a></li>
<li><a href="#predicates">Predicates</a></li>
<li><a href="#types">Types</a></li>
<li><a href="#maps">Maps</a></li>
<li><a href="#demo-creating-a-session">Demo Creating a Session</a></li>
</ul></li>
<li><a href="#extended-events-automation">Extended Events Automation</a>

<ul>
<li><a href="#scripting-the-session">Scripting the Session</a></li>
</ul></li>
<li><a href="#testing-the-session-with-data">Testing the Session with Data</a></li>
<li><a href="#displaying-results">Displaying Results</a>

<ul>
<li><a href="#view-target-data">View Target Data</a></li>
<li><a href="#watch-live-data">Watch Live Data</a></li>
</ul></li>
</ul>

<h2 id="extended-events">Extended Events</h2>

<p>In this module we will cover using Extended Events. SQL Server Extended Events has a highly scalable and highly configurable architecture that allows users to collect as much or as little information as is necessary to troubleshoot or identify a performance problem.</p>

<h2 id="benefits-of-sql-server-extended-events">Benefits of SQL Server Extended Events</h2>

<p>Extended Events allows you to do the following:</p>

<ul>
<li>Graphically monitor SQL Server queries</li>
<li>Collect query information in the background</li>
<li>Analyze performance</li>
<li>Diagnose problems such as deadlocks</li>
<li>Debug a Transact-SQL (T-SQL) statement</li>
<li>Extended Events is a light weight performance monitoring system that uses very few performance resources.</li>
</ul>

<h3 id="sql-server-management-studio-extended-events-integration">SQL Server Management Studio Extended Events Integration</h3>

<p>SQL Server Management Studio provides an excellent user interface (UI) for extended events. The UI is so good that many users have no need to engage with extended events by using Transact-SQL or the dynamic management views (DMVs) that target extended events.</p>

<p><img src="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/images/extended-events-ssms-integration.png" alt="Extended Events SQL Server Integration" /></p>

<h2 id="extended-events-concepts">Extended Events Concepts</h2>

<p>SQL Server Extended Events (Extended Events) builds on existing concepts, such as an event or an event consumer, uses concepts from Event Tracing for Windows(ETW), and introduces new concepts.</p>

<ul>
<li>Package</li>
<li>Session</li>
<li>Events</li>
<li>Targets</li>
<li>Predicates</li>
</ul>

<h3 id="package">Package</h3>

<p>A <strong>package</strong> is a container for SQL Server Extended Events objects. There are three kinds of Extended Events packages, which include the following:</p>

<ul>
<li><strong>package0</strong> - Extended Events system objects. This is the default package.</li>
<li><strong>sqlserver</strong> - SQL Server related objects.</li>
<li><strong>sqlos</strong> - SQL Server Operating System (SQLOS) related objects.</li>
</ul>

<p>Packages are identified by a name, a GUID, and the binary module that contains the package. We can use the <code>sys.dm_xe_packages</code> DMV to look at more information about packages. Here is an example listing the available packages and the dll file providing the module :</p>

<pre><code class="language-sql">SELECT xe.name, xe.description, os.name
FROM sys.dm_xe_packages xe
JOIN sys.dm_os_loaded_modules os
ON xe.module_address = os.base_address
</code></pre>

<h3 id="package-contents">Package Contents</h3>

<p>The following illustration shows the objects that can exist in packages, which are contained in a module. A module can be an executable or a dynamic link library.</p>

<p><img src="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/images/xepackagesobjects.gif" alt="Package Contents" /></p>

<h3 id="events">Events</h3>

<p>Events are monitoring points of interest in the execution path of a program, such as SQL Server. An event firing carries with it the fact that the point of interest was reached, and state information from the time the event was fired.</p>

<p>Events can be used solely for tracing purposes or for triggering actions. These actions can either be synchronous or asynchronous.</p>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>An event does not have any knowledge of the actions that may be triggered in response to the event firing.</p>
</div>

<p>All events have a versioned schema which defines their contents. This schema is composed of event columns with well defined types. An event of a specific type must always provide its data in exactly the same order that is specified in the schema. However, an event target does not have to consume all the data that is provided.</p>

<p>We can query for available events using the following DMV, <code>sys.dm_xe_objects</code> as follows :</p>

<pre><code class="language-sql">SELECT name, description
FROM sys.dm_xe_objects
WHERE object_type = 'event'
ORDER BY name
</code></pre>

<h3 id="event-categorization">Event Categorization</h3>

<p>Extended Events uses an event categorization model similar to Event Tracing for Windows (ETW). Two event properties are used for categorization, channel and keyword.</p>

<h3 id="channel">Channel</h3>

<p>A channel identifies the audience for an event. These channels are described in the following table.</p>

<table>
<thead>
<tr>
<th>Term</th>
<th>Definition</th>
</tr>
</thead>

<tbody>
<tr>
<td>Admin</td>
<td>Admin events are primarily targeted to the end users, administrators, and support. The events that are found in the admin channels indicate a problem with a well-defined solution that an administrator can act on. An example of an admin event is when an application fails to connect to a printer. These events are either well-documented or have a message associated with them that tells the reader what to do to rectify the problem.</td>
</tr>

<tr>
<td>Operational</td>
<td>Operational events are used for analyzing and diagnosing a problem or occurrence. They can be used to trigger tools or tasks based on the problem or occurrence. An example of an operational event is when a printer is added or removed from a system.</td>
</tr>

<tr>
<td>Analytic</td>
<td>Analytic events are published in high volume. They describe program operation and are typically used in performance investigations.</td>
</tr>

<tr>
<td>Debug</td>
<td>Debug events are used solely by developers to diagnose a problem for debugging.</td>
</tr>
</tbody>
</table>

<p>Events in the Debug channel return internal implementation-specific state data. The schemas and data that the events return may change or become invalid in future versions of SQL Server. Therefore, events in the Debug channel may change or be removed in future versions of SQL Server without notice.</p>

<h3 id="keyword">Keyword</h3>

<p>A keyword is application specific and enables a finer-grained grouping of related events, which makes it easier for you to specify and retrieve an event that you want to use in a session. You can use the following query to obtain keyword information.</p>

<pre><code class="language-sql">SELECT map_value Keyword 
FROM sys.dm_xe_map_values  
WHERE name = 'keyword_map'
</code></pre>

<h3 id="targets">Targets</h3>

<p>SQL Server Extended Events targets are event consumers. Targets can write to a file, store event data in a memory buffer, or aggregate event data. Targets can process data synchronously or asynchronously.</p>

<p>Extended Events provide the following targets that you can use for an Extended Events session:</p>

<ul>
<li><p><strong>Event counter</strong> - Counts all specified events that occur during an Extended Events session. Use to obtain information about workload characteristics without adding the overhead of full event collection. This is a synchronous target.</p></li>

<li><p><strong>Event file</strong> - Use to write event session output from complete memory buffers to disk. This is an asynchronous target.</p></li>

<li><p>Event pairing - Many kinds of events occur in pairs, such as lock acquires and lock releases. Use to determine when a specified paired event does not occur in a matched set. This is an asynchronous target.</p></li>

<li><p><strong>Event Tracing for Windows (ETW)</strong> - Use to correlate SQL Server events with Windows operating system or application event data. This is a synchronous target.</p></li>

<li><p><strong>Histogram</strong> - Use to count the number of times that a specified event occurs, based on a specified event column or action. This is an asynchronous target.</p></li>

<li><p><strong>Ring buffer</strong> - Use to hold the event data in memory on a first-in first-out (FIFO) basis, or on a per-event FIFO basis. This is an asynchronous target.</p></li>
</ul>

<h3 id="actions">Actions</h3>

<p>An action is a programmatic response or series of responses to an event. Actions are bound to an event, and each event may have a unique set of actions. Actions can:</p>

<ul>
<li>Capture a stack dump and inspect data.</li>
<li>Capture the query plan hash</li>
<li>Capture the sql query hash</li>
<li>Store state information in a local context using variable storage.</li>
<li>Aggregate event data.</li>
<li>Append data to event data.</li>
</ul>

<h3 id="predicates">Predicates</h3>

<p>Predicates are a set of logical rules that are used to evaluate events when they are processed. This enables the Extended Events user to selectively capture event data based on specific criteria.</p>

<p>Predicates are evaluated as full Boolean expressions, and support short circuiting at the first point where the entire expression is found to be false.</p>

<p>Predicates can store data in a local context that can be used for creating predicates that return true once every n minutes or every n times that an event fires.</p>

<h3 id="types">Types</h3>

<p>Because data is a collection of bytes strung together, the length and characteristics of the byte collection are required in order to interpret the data. This information is encapsulated in the Type object. The following types are provided for package objects:</p>

<ul>
<li>event</li>
<li>action</li>
<li>target</li>
<li>pred_source</li>
<li>pred_compare</li>
<li>type</li>
</ul>

<p>We can use the following to look at the type available :</p>

<pre><code class="language-sql">SELECT object_type, count(*) total
FROM sys.dm_xe_objects
GROUP BY object_type
</code></pre>

<h3 id="maps">Maps</h3>

<p>A map table maps an internal value to a string, which enables a user to know what the value represents. Instead of only being able to obtain a numeric value, a user can get a meaningful description of the internal value. The following query shows how to obtain map values.</p>

<pre><code class="language-sql">SELECT map_key, map_value, name
FROM sys.dm_xe_map_values
</code></pre>

<h3 id="demo-creating-a-session">Demo Creating a Session</h3>

<ol>
<li>Connect with <strong>SSMS</strong>.</li>
<li>In the Object Explorer, click <strong>Management</strong> &gt; <strong>Extended Events</strong> &gt; <strong>New Session</strong>. The <strong>New Session</strong> dialog is preferable to the <strong>New Session Wizard</strong>, although the two are similar to each other.</li>

<li><p>In the upper-left, click the <strong>General</strong> page. Then type <strong>Demo</strong>, or any name you like, into the Session name text box. Do not press the <strong>OK</strong> button yet, that comes only at the end of the demo.</p>

<p><img src="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/images/extended-events/choose-session-name.png" alt="Extended Events Session Wizard" /></p>

<p>You can choose some predefined session here using the template, but in this section we will choose the events manually.</p>

<p>Using the wizard we can create a session to gather performance data. Here are the available templates :</p>

<ul>
<li><p><strong>Query Batch Sampling</strong> - This template will capture queries and procedure calls for 20 percent of all active sessions on the server.</p></li>

<li><p><strong>Query Batch Tracking</strong> - This template captures all queries and procedures for all sessions on the server.</p></li>

<li><p><strong>Query Detail Sampling</strong> - This template contains a set of events that will capture every statement in queries and procedures for 20 percent of all active sessions on the server.</p></li>

<li><p><strong>Query Detail Tracking</strong> - This template is the same as Query Batch Tracking, but for every single statement in the system as well. This generates a large amount of data.</p></li>

<li><p><strong>Query Wait Statistic</strong> - This template captures wait statistics for each statement of every query and procedure for 20 percent of all active sessions.</p></li>
</ul>

<p><img src="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/images/extended-events/session-templates.png" alt="Session Tempaltes" /></p></li>

<li><p>In the upper-left, click the <strong>Events</strong> page, and then click the <strong>Select</strong> button. <img src="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/images/extended-events/choose-an-event.png" alt="Event Selection" /></p></li>

<li><p>In the <strong>Event library</strong> area, in the drop-down list, choose <strong>Event names</strong> only.</p>

<ul>
<li>Into the text box, type in <strong>sql</strong>, which filters and reduces the long list of available events by using a contains operator.</li>
<li>Scroll and click the event named <strong>sql_statement_completed</strong>.</li>
<li>Click the right arrow button <strong>&gt;</strong> to move the event to the <strong>Selected events</strong> box.</li>
</ul></li>

<li><p>Staying on the Events page, click the <strong>Configure</strong> button at the far right.</p>

<ul>
<li>With the left side chopped off for better display, in the following screenshot you can see the Event configuration options area.</li>
</ul></li>

<li><p>Click the <strong>Filter (Predicate)</strong> tab. Next, click <strong>Click here to add a clause</strong>, for the intention of capturing all SQL SELECT statements that have a HAVING clause.</p></li>

<li><p>In the Field drop-down list, and choose <strong>sqlserver.sql_text</strong>.</p>

<ul>
<li>For Operator choose a <strong>LIKE</strong> operator.</li>
<li>For Value type in <strong>%SELECT%HAVING%</strong> <img src="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/images/extended-events/add-a-filter.png" alt="Extended Events add a Predicate" /></li>
</ul></li>

<li><p>In the upper-left, click the <strong>Data Storage</strong> page.</p></li>

<li><p>In the <strong>Targets</strong> area, click <strong>Click here to a target</strong>.</p>

<ul>
<li>In the <strong>Type</strong> drop-down list, choose <strong>event_file</strong>.</li>
<li>This means the event data will be stored in a file that we can view.</li>
</ul></li>

<li><p>In the <strong>Properties</strong> area, type in a full path and file name into the File name on server text box.</p>

<ul>
<li>The file name extension must be <em>.xel</em>.</li>
<li>Our little test will need less than 1 MB of file size. <img src="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/images/extended-events/choose-a-file-target.png" alt="Choose a file target" /></li>
</ul></li>

<li><p>In the upper-left, click the <strong>Advanced</strong> page.
Leave the <strong>Maximum dispatch latency</strong> at 30 seconds.
Finally, click the <strong>OK</strong> button at the bottom. <img src="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/images/extended-events/choose-maximum-dispatch-latency.png" alt="Choose Maximum Dispatch Latence" /></p></li>

<li><p>Back in the <strong>Object Explorer</strong>, expand <strong>Management</strong> &gt; <strong>Sessions</strong>, and see the new node for <strong>Demo</strong>. <img src="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/images/extended-events/object-explorer-extended-events.png" alt="Extended Eevents Object Explorer Properties" /></p></li>
</ol>

<h2 id="extended-events-automation">Extended Events Automation</h2>

<p>You can script the Extended Events Session from within the wizard. This script can then be applied on other server to gather the same metrics.</p>

<h3 id="scripting-the-session">Scripting the Session</h3>

<ol>
<li>Define a session.</li>
<li>Right-click the <strong>Demo</strong> session, and select <strong>Script Sessions As</strong> &gt; <strong>CREATE To</strong> &gt; <strong>File</strong> to output straight to a file. Or, use the <strong>Script</strong> button at the top of the <strong>New Session</strong> window to create a T-SQL command in the Query window.</li>
<li>These steps will generate the script that you need to create a session and output it to a file.</li>
</ol>

<p><img src="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/images/extended-events/script-session.png" alt="Script Session to File" /></p>

<p>To manually create this new trace, use Management Studio as follows:</p>

<ol>
<li>Open the script file or navigate to the Query window.</li>
<li>Modify the path and file location for the server you’re creating this session on.</li>
<li>Execute the script.</li>
</ol>

<p><img src="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/images/extended-events/session-properties-script-to-file.png" alt="Script Session to a File using Session Properties" /></p>

<p>Here is the SQL script of the session :</p>

<pre><code class="language-sql">CREATE EVENT SESSION [Demo] ON SERVER 
ADD EVENT sqlserver.sql_statement_completed(
    WHERE ([sqlserver].[like_i_sql_unicode_string]([sqlserver].[sql_text],N'%SELECT%HAVING%')))
ADD TARGET package0.event_file(SET filename=N'C:\Temp\Demo.xel',max_file_size=(10))
WITH (MAX_MEMORY=4096 KB,
		EVENT_RETENTION_MODE=ALLOW_SINGLE_EVENT_LOSS,
		MAX_DISPATCH_LATENCY=30 SECONDS,MAX_EVENT_SIZE=0 KB,
		MEMORY_PARTITION_MODE=NONE,
		TRACK_CAUSALITY=OFF,
		STARTUP_STATE=OFF)
GO
</code></pre>

<p>Once the session is created, you can use the following command to start it:</p>

<pre><code class="language-sql">ALTER EVENT SESSION [Demo]
ON SERVER
STATE = START;
</code></pre>

<h2 id="testing-the-session-with-data">Testing the Session with Data</h2>

<p>Test your event session with these simple steps:</p>

<ol>
<li>In the SSMS <strong>Object Explorer</strong>, right-click <strong>Demo</strong> session node, and then click <strong>Start Session</strong>.</li>

<li><p>Run the following SELECT&hellip;HAVING statement a couple times.</p>

<ul>
<li>Ideally you might change the HAVING Count value between the two runs, toggling between 2 and 3. This enables you to see the differences in the results.</li>
</ul>

<pre><code class="language-sql">    SELECT
        c.name,
        Count(*)  AS [Count-Per-Column-Repeated-Name]
    FROM
            sys.syscolumns  AS c
        JOIN sys.sysobjects  AS o

            ON o.id = c.id
    WHERE
        o.type = 'V'
        AND
        c.name like '%event%'
    GROUP BY
        c.name
    HAVING
        Count(*) &gt;= 3   --2     -- Try both values during session.
    ORDER BY
        c.name;
</code></pre></li>

<li><p>Right-click your session node, and then click <strong>Stop Session</strong>.</p></li>
</ol>

<h2 id="displaying-results">Displaying Results</h2>

<p>You can view the results in two ways :</p>

<ul>
<li>View target data</li>
<li>Watch live data</li>
</ul>

<h3 id="view-target-data">View Target Data</h3>

<p>In the SSMS <strong>Object Explorer</strong>, you can right-click the target node which is under your event session node. In the context menu you click <strong>View Target Data</strong>. SSMS displays the data.
The display is not updated as new data is reported by the event. But you can click View Target Data again.</p>

<p><img src="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/images/extended-events/view-target-data.png" alt="View Target Data" /></p>

<h3 id="watch-live-data">Watch Live Data</h3>

<p>n the SSMS <strong>Object Explorer</strong>, you can right-click your <strong>Demo</strong> session node. In the context menu you click <strong>Watch Live Data</strong>. SSMS displays incoming data as it continues to arrive in real time.</p>

<p><img src="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/images/extended-events/watch-live-data.png" alt="Watch Live Data" /></p>


			<aside class="copyright" role="note">
				
				&copy; 2017 Copyright 2017 Peruzal &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/sql-performance-analysis/" title="SQL Performance Analysis">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              SQL Performance Analysis
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/index-analysis/" title="Index Analysis">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Index Analysis
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = '';
      var repo_id  = '';
    
    </script>

    <script src="http://guides.peruzal.com/sql-server-performance-tuning-and-optimization/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

